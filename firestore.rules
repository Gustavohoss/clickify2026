/**
 * Core Philosophy: This ruleset enforces a strict user-ownership model.
 * All data is considered private and can only be accessed by the user who owns it.
 * The security model is designed for authorization independence, meaning access decisions
 * are made without needing to read other documents, leading to better performance.
 *
 * Data Structure: All user-specific data is nested under the `/users/{userId}` path,
 * where `{userId}` is the Firebase Authentication UID of the user. This creates a clear
 * and isolated data tree for each user, containing their profile and related subcollections
 * like `canvasSettings`.
 *
 * Key Security Decisions:
 * - Default Deny: All paths are closed by default. Access is only granted explicitly.
 * - No User Enumeration: Listing the top-level `/users` collection is explicitly forbidden
 *   to prevent scraping user information.
 * - Path-Based Ownership: A user's identity in the path (`/users/{userId}`) is the
 *   primary source of truth for all authorization checks on data within that tree.
 * - Immutable Ownership Links: Once a document is created with an ownership link (e.g., a
 *   `userId` field), that link cannot be changed, preventing data from being reassigned.
 *
 * Denormalization for Authorization: The data model uses Path-Based Ownership, where the
 * user's UID is part of the document path (e.g., `/users/{userId}/...`). This is a form of
 * denormalization that makes rules simple and fast, as ownership can be verified directly
 * from the path without requiring extra database reads (`get()` calls).
 *
 * Structural Segregation: User data is segregated into a private tree under `/users/{userId}`.
 * User-specific settings are stored in a dedicated subcollection (`canvasSettings`),
 * which isolates them from the main user profile document and simplifies security rules.
 */
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // =====================================================================
    // Helper Functions
    // =====================================================================

    /**
     * Checks if the requesting user's UID matches the provided userId.
     * This is the foundation of the user-ownership security model.
     */
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }

    /**
     * Checks for ownership on an existing document. Used for update and delete
     * operations to ensure the document exists before allowing the change.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * Validates a new User document on creation.
     * Ensures the creator is the owner and the internal 'id' field matches the path.
     */
    function userDocIsValidOnCreate(userId) {
      return isOwner(userId) && request.resource.data.id == userId;
    }

    /**
     * Validates a User document on update.
     * Ensures the editor is the owner and the 'id' field remains unchanged.
     */
    function userDocIsValidOnUpdate(userId) {
      return isExistingOwner(userId) && request.resource.data.id == resource.data.id;
    }

    /**
     * Validates a new CanvasSetting document on creation.
     * Ensures the creator is the owner and the internal 'userId' field matches the path.
     */
    function canvasSettingIsValidOnCreate(userId) {
      return isOwner(userId) && request.resource.data.userId == userId;
    }

    /**
     * Validates a CanvasSetting document on update.
     * Ensures the editor is the owner and the 'userId' field remains unchanged.
     */
    function canvasSettingIsValidOnUpdate(userId) {
      return isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
    }

    // =====================================================================
    // Collection Rules
    // =====================================================================

    /**
     * @description Manages user profile documents. Each user can create, read,
     *   update, and delete their own profile, but cannot access anyone else's.
     * @path /users/{userId}
     * @allow (get) A logged-in user (auth.uid='user_abc') reading their own document at `/users/user_abc`.
     * @deny (get) A logged-in user (auth.uid='user_abc') reading another user's document at `/users/user_xyz`.
     * @deny (list) Any user attempting to list all documents in the `/users` collection.
     * @principle Restricts access to a user's own data tree and prevents user enumeration.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if userDocIsValidOnCreate(userId);
      allow update: if userDocIsValidOnUpdate(userId);
      allow delete: if isExistingOwner(userId);

      /**
       * @description Manages canvas settings for a specific user.
       *   A user has full control over their own settings.
       * @path /users/{userId}/canvasSettings/{canvasSettingId}
       * @allow (create) A user (auth.uid='user_abc') creating a new setting document at `/users/user_abc/canvasSettings/setting_123`.
       * @deny (get) A user (auth.uid='user_abc') trying to read a setting from another user's path at `/users/user_xyz/canvasSettings/setting_456`.
       * @principle Enforces strict data isolation within a user's private subcollection.
       */
      match /canvasSettings/{canvasSettingId} {
        allow get: if isOwner(userId);
        allow list: if isOwner(userId);
        allow create: if canvasSettingIsValidOnCreate(userId);
        allow update: if canvasSettingIsValidOnUpdate(userId);
        allow delete: if isExistingOwner(userId);
      }
    }
  }
}